name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
env:
  AZURE_WEB_APP: 'github-actions-test-anilappari'
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Official SonarQube Scan
      # You may pin to the exact commit or the version.
      # uses: SonarSource/sonarqube-scan-action@7295e71c9583053f5bf40e9d4068a0c974603ec8
      uses: SonarSource/sonarqube-scan-action@v1.1.0
      with:
        # Additional arguments to the sonar-scanner
        args: # optional
        # Set the sonar.projectBaseDir analysis property
        projectBaseDir: # optional, default is .

    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest

    - name: login to acr
      run: docker login -u '${{secrets.ACR_LOGIN_NAME}}' -p '${{secrets.ACR_PASSWORD}}' '${{secrets.ACR_LOGIN_SERVER}}'

    - name: push to ecr
      run: docker push '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest


    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDS_SP }}

    - name: Azure WebApp Deployment
      uses: Azure/webapps-deploy@v2.2.3
      with: 
        app-name: github-actions-test-anilappari
        images: '${{secrets.ACR_LOGIN_SERVER}}/my-image-name:latest'


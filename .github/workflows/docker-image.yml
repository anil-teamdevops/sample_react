name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
env:
  AZURE_WEB_APP: 'github-actions-test-anilappari'
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest

    - name: login to acr
      run: docker login -u '${{secrets.ACR_LOGIN_NAME}}' -p '${{secrets.ACR_PASSWORD}}' '${{secrets.ACR_LOGIN_SERVER}}'

    - name: push to ecr
      run: docker push '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest


    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDS_SP }}

    # - name: Azure WebApp Deployment
    #   uses: Azure/webapps-deploy@v2
    #   with:
    #     app-name: '${{env.AZURE_WEB_APP}}'
    #     images: '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest

    - name: Azure WebApp
      uses: Azure/webapps-deploy@v2
      with:
        # Name of the Azure Web App
        app-name: ${{env.AZURE_WEB_APP}}
        # Applies to Web App Containers only: Specify the fully qualified container image(s) name. For example, 'myregistry.azurecr.io/nginx:latest' or 'python:3.7.2-alpine/'. For multi-container scenario multiple container image names can be provided (multi-line separated)
        images: '${{secrets.ACR_LOGIN_SERVER}}'/my-image-name:latest